
<!DOCTYPE html>
<html>
<head>
    <title>Stria Example</title>
</head>
<body>
    <h1>Stria</h2>
    <h4>By John Chowning</h3>
    <h4>Reconstruction by K. Dahan</h4> 
    <h4>Web page by Michael Gogins</h4> 
    <h4>Original version by Victor Lazzarini</h4> 
    <p>This Web page provides a simple example, with a thorough explanation, of how to embed a piece of Csound 
    music into a Web page, so that it is editable, and play it, using the PNaCl build of Csound. 
    All unnecessary HTML elements and JavaScript function calls have been omitted.</p>
    <p>As we proceed through the tutorials, more and more features of HTML5 will be integrated with 
    Csound, adding features to this piece.</p>
    <p>Comments on this page or in the page source explain what each element is for and why it is 
    written the way it is. You can view the code and comments by right-clicking on this page and selecting 
    "View page source".</p>
    <h3>Embedding Csound</h3>
    <p>PNaCl ("pinnacle") is Google's technology for <it>safely</it>running C and C++ code in all desktop versions of 
    Google's Chrome browser. For more information on PNaCl, go to 
    <a href='https://developer.chrome.com/native-client'>here</a>. I will not discuss the internals of PNaCl or 
    of the Csound build here, except to note that:
    <ul>
        <li>PNaCl applications must be loaded from a Web server. In this case, that is GitHub, the host for 
        http://gogins.github.io.</li>
        <li>PNaCl applications are compiled twice by Google's toolchain: first by the developer to compile a 
        .pexe file for the browser to load, and then by the browser itself to compile and cache a .nexe file 
        that is a true machine language program for the browser's CPU. Because the application runs as 
        machine language, it runs only about 5 or 10% slower than a regular compiled C or C++ program. For audio
        applications, this is a huge advantage.</li>
        <li>The browser knows how to load the application by reading an "embed" tag that points to the 
        .pexe file and to the manifest, a .nmf file.</li>
        <li>The application runs in a security sandbox in a separate process, and communicates with the 
        browser by means of messages sent via Google's Pepper API.</li>
    </ul>
    <p>To embed Csound for PNaCl in a Web page, simply load the "csound.js" script using a "script" element. 
    This contains JavaScript that dynamically creates the "embed" tag, and also manages sending and receiving 
    messages from the Csound process. To the Web page, Csound is just a JavaScript object named "csound", with 
    its own functions and callbacks, which represent important parts of the Csound API.</p>
    <p>It is good practice to place all "script" elements at the very end of the HTML "body" element, so that the 
    other elements have already been created before any scripts try to access them, and that is what I have 
    done here.</p>
    <p>Finally, the very last element in the body must be named "engine". The "csound.js" script obtains this 
    element, attaches the "embed" element to it, and then attaches Csound's callbacks to it.</p>
    <h3>Embedding the Csound Score and Orchestra</h3>
    <p>There are many to get a Csound piece into Csound for PNaCl. But in order to make the Csound orchestra and 
    score editable, they must appear in "textarea" elements on the Web page. These can be smaller than the text 
    they contain, but have scrollbars for accessing all of the text. These textareas must be named so that we 
    can use JavaScript code to retrieve the orchestra and score, and pass them to Csound.</p>
    <p>This textarea is named "orc" and contains the Csound orchestra.</p>
    <textarea id="orc" rows=24 cols=80>
    </textarea>
    <p>This textarea is named "sco" and contains the Csound score.</p>
    <textarea id="sco" rows=24 cols=80>
    </textarea>
    <h3>Starting and Stopping Csound</h3>
    <p>It is convenient to provide buttons for starting and stopping Csound, rather than simply having it start 
    playing the moment the page is loaded. The JavaScript code for handling the button clicks must start 
    Csound, send the orchestra, and send the score to perform the piece. For stopping Csound, it is necessary 
    to reload the entire page, but this can also be done with a button.</p>
    <input type="button" value="Start playing" onclick="start_onclick()"/>
    <input type="button" value="Stop playing" onclick="stop_onclick()"/>
    <h3>Handling Csound's Errors, Warnings, and Messages</h3>
    <textarea id="console" rows=10 cols=80></textarea>
    <script type="text/javascript" src="csound.js"></script>
    <script>
    var start_onclick = function() {
        csound.PlayCsd("http/stria.csd");
    }
    // It is necessary to refresh the page to stop Csound, because the PNaCl build of Csound 
    // does not provide a "stop" function. However, this workaround seems to work well.
    var stop_onclick = function() {
        location.reload();
    }
    // Messages both from the "csound.js" wrapper and from Csound itself are combined in the 
    // "console" text area.
    function handleMessage(message) {
        var messages_textarea = document.getElementById("console");
        var existing = messages_textarea.value;
        messages_textarea.value = existing + message.data;
        messages_textarea.scrollTop = messages_textarea.scrollHeight;    
    }
    // The "engine" element should be the very last HTML element in the body. That is because 
    // the "csound.js" wrapper uses the "engine" element to embed the PNaCl Csound module in this Web page.
    </script>
    <!--pNaCl csound module-->
    <div id="engine"></div>
</body>
</html>

