<!DOCTYPE html>
<html>
<head>
<title>Csound</title>
</head>
<body style="background-color:LightGrey;">
<script src="csound_extended.js"></script>
<script src="CsoundAudioNode.js"></script>
<script>
/**
 * This script attempts to load, and to use, in order of decreasing 
 * preference: 
 * (1) Injected csound (e.g. Csound for Android, CsoundQt).
 * (2) csound.node.
 * (3) Csound for WebAssembly with AudioWorklet (CsoundWebAudio).
 * (4) Csound for WebAssmebly with ScriptProcessorNode (CsoundAudioNode).
 * To use this script, include it in the _body_ of your Web page and then call 
 * get_csound(csound_message_callback). The result will be a global csound 
 * object, if one is available on your system.
 */
 
// These are globals:
var csound_initialized = false;
var csound_injected = null;
var csound_node = null;
var csound_audio_node = null;
var csound_web_audio = null;
var csound_extended = {};

let print_;
if (typeof csound_message_callback === 'undefined') {
    print_ = console.log;
} else {
    print_ = csound_message_callback;
}

/**
 * Returns an initialized instance of Csound. This function should _only_ be 
 * called _after_ a user gesture on the page.
 */
var get_csound = function(csound_message_callback_) {
    if (csound_initialized === false) {
        if (typeof csound != 'undefined') {
            if (csound != null) {
                csound_initialized = true;
                csound_injected = csound;
                print_("Csound already exists in this JavaScript context.\n");
                return csound_injected;
            }
        }
        try {
            print_("Trying to load csound.node...\n");
            csound_node = require('csound.node');
            var nwgui = require('nw.gui');
            nw_window = nwgui.Window.get();
            nw_window.on('close', function() {
                print_('Closing down...\n');
                this.close(true); 
            });
            csound_node.SetMessageCallback(csound_message_callback);
            print_("csound.node is available in this JavaScript context.\n");
            // Workaround for Emscripten not knowing that NW.js is a variant of Node.js.
            csound_extended["ENVIRONMENT"] = "NODE";
            csound_initialized = true;
            return csound_node;
         } catch (e) {
            print_(e + '\n');
        }
        try {
            print_("Trying to load CsoundAudioNode (AudioWorklet)...\n");
            AudioContext = window.AudioContext || window.webkitAudioContext;
            audioContext = new AudioContext();
            const loader = async (audioContext) => {
                await audioContext.audioWorklet.addModule('CsoundAudioProcessor.js');
                csound_message_callback("Creating CsoundAudioNode...\n");
                csound_audio_node = new CsoundAudioNode(audioContext);
                csound_audio_node.SetMessageCallback(csound_message_callback);
                csound_message_callback("CsoundAudioNode is available in this JavaScript context.\n");    
            };
            loader(audioContext);
        } catch (e) {
            print_(e + '\n');
        }
        try {
            print_("Trying to load CsoundWebAudio (ScriptProcessorNode)...");
            csound_extended_module(csound_extended).then(function(module) {
                csound_extended = module;
                csound_web_audio = new csound_extended.CsoundWebAudio();
                csound_web_audio.SetMessageCallback(csound_message_callback);
                print_("CsoundWebAudio is available in this JavaSript contex.\n");
            });
        } catch (e) {
            print_(e + '\n');
        }
        // May not actually be the case, but we tried. Needs to be set for the next call.
        csound_initialized = true;
    }
    if (csound_injected != null) {
        return csound_injected;
    } else if (csound_node !== null) {
        return csound_node;
    } else if (csound_audio_node !== null) {
        return csound_audio_node;
    } else if (csound_web_audio !== null) {
        return csound_web_audio;
    } else {
        print_("Csound is loading, wait a bit...\n");
        return null;
    }
}       
</script>
<script>
var csd = null;
var csound_message_callback = function(message) {
    let messages_textarea = document.getElementById("console");
    let existing = messages_textarea.value;
    messages_textarea.value = existing + message;
    messages_textarea.scrollTop = messages_textarea.scrollHeight;        
};
var onPlayClick = async function() {
    let messages_textarea = document.getElementById("console");
    messages_textarea.value = "";
    let csound = get_csound(csound_message_callback);
    if (csound == null) {
        csound_message_callback("Csound is still loading, try again...\n");
        return;
    }
    csound_message_callback("Csound class name: " + csound.constructor.name + "\n");
    csd = document.getElementById('csd').value;
    await csound.CompileCsdText(csd);
    await csound.Start();
    await csound.Perform();
};
var onPlayStop = async function() {
    let csound = get_csound(csound_message_callback);
    await csound.Stop();
    await csound.Cleanup();
    await csound.Reset();
    csound = null;
};
</script>
<h2>Csound Player</h2>
<p>
Any self-contained Csound piece (.csd file) can be performed by pasting it into the text area below, and clicking on the <b>Play</b> button. Click on the <b>Stop</b> button to end the performance. The second text area will show Csound's runtime messages. You can edit the .csd file in the text area, but you must select it all and copy it out somewhere else order to save it.
</p>
<p>
<input id="play" type="button" value="Play" onclick="onPlayClick()">
<input id="stop" type="button" value="Stop" onclick="onPlayStop()">
</p>
<textarea id='csd' style="width:98vw;height:50vh;font-family:monospace;background-color:MidnightBlue;color:NavajoWhite;">
<CsoundSynthesizer>
<CsOptions>
-odac -d -m195
</CsOptions>
<CsInstruments>
; The value of sr must match the host.
sr          =           44100
; The value of 128 is required by WebAudio.
ksmps       =           128
; The values of both nchnls and nchnls_i must match the host.
nchnls      =           2
nchnls_i    =           1
;--------------------------------------------------------
;Instrument 1 : plucked strings chorused left/right and
;       pitch-shifted and delayed taps thru exponential
;       functions, and delayed.
;--------------------------------------------------------

            instr       1
ishift      =           .00666667               ;shift it 8/1200.
ipch        =           cpspch(p5)              ;convert parameter 5 to cps.
ioct        =           octpch(p5)              ;convert parameter 5 to oct.
kvib        poscil      1/120, ipch/50, 1       ;vibrato
ag          pluck       2000, cpsoct(ioct+kvib), 1000, 1, 1
agleft      pluck       2000, cpsoct(ioct+ishift), 1000, 1, 1
agright     pluck       2000, cpsoct(ioct-ishift), 1000, 1, 1
adamping    linsegr     0.0, 0.006, 1.0, p3 - 0.066, 1.0, 0.06, 0.0
ag          =           adamping * ag
agleft      =           adamping * agleft
agright     =           adamping * agright
af1         expon       .1, p3, 1.0             ;exponential from 0.1 to 1.0
af2         expon       1.0, p3, .1             ;exponential from 1.0 to 0.1
adump       delayr      2.0                     ;set delay line of 2.0 sec
atap1       deltap3     af1                     ;tap delay line with kf1 func.
atap2       deltap3     af2                     ;tap delay line with kf2 func.
ad1         deltap3     2.0                     ;delay 2 sec.
ad2         deltap3     1.1                     ;delay 1.1 sec.
            delayw      ag                      ;put ag signal into delay line.
            outs        agleft+atap1+ad1, agright+atap2+ad2
            endin
;-------------------------------------------------------------
;Instrument 2 : plucked strings chorused left/right and
;       pitch-shifted with fixed delayed taps.
;------------------------------------------------------------

            instr       2
ishift      =           .00666667               ;shift it 8/1200.
ipch        =           cpspch(p5)              ;convert parameter 5 to cps.
ioct        =           octpch(p5)              ;convert parameter 5 to oct.
kvib        poscil      1/120, ipch/50, 1       ;vibrato
ag          pluck       1000, cpsoct(ioct+kvib), 1000, 1, 1
agleft      pluck       1000, cpsoct(ioct+ishift), 1000, 1, 1
agright     pluck       1000, cpsoct(ioct-ishift), 1000, 1, 1
adamping    linsegr     0.0, 0.006, 1.0, p3 - 0.066, 1.0, 0.06, 0.0
ag          =           adamping * ag
agleft      =           adamping * agleft
agright     =           adamping * agright
adump       delayr      0.3                     ;set delay line of 0.3 sec
ad1         deltap3     0.1                     ;delay 100 msec.
ad2         deltap3     0.2                     ;delay 200 msec.
            delayw      ag                      ;put ag sign into del line.
            outs        agleft+ad1, agright+ad2
            endin
;-----------------------------------------------------------
;Instrument 3 : New FM algorithm, modified to produce large timbre
;               shifts using modulation of I and r. Detuned chorusing employed.
;-----------------------------------------------------------
            instr       3
ishift      =           .00666667               ;shift it 8/1200.
ipch        =           cpspch(p5)              ;convert parameter 5 to cps.
ioct        =           octpch(p5)              ;convert parameter 5 to oct.
aadsr       linsegr     0, p3/3, 1.0, p3/3, 1.0, p3/3, 0 ;ADSR envelope
amodi       linseg      0, p3/3, 5, p3/3, 3, p3/3, 0 ;ADSR envelope for I
amodr       linseg      p6, p3, p7              ;r moves from p6->p7 in p3 sec.
a1          =           amodi*(amodr-1/amodr)/2
a1ndx       =           abs(a1*2/20)            ;a1*2 is normalized from 0-1.
a2          =           amodi*(amodr+1/amodr)/2
a3          tablei      a1ndx, 3, 1             ;lookup tbl in f3, normal index
ao1         poscil      a1, ipch, 2             ;cosine
a4          =           exp(-0.5*a3+ao1)
ao2         poscil      a2*ipch, ipch, 2        ;cosine
aoutl       poscil      1000*aadsr*a4, ao2+cpsoct(ioct+ishift), 1 ;fnl outleft
aoutr       poscil      1000*aadsr*a4, ao2+cpsoct(ioct-ishift), 1 ;fnl outright
            outs        aoutl, aoutr
            endin

</CsInstruments>
<CsScore>
;       Score for final project in Digital Audio Processing
;       ---------------------------------------------------

;           Piece entitled :  X A N A D U (short version)
;                           Joseph T. Kung, 12/12/88
;            Instruments modified for higher precision
;                         Michael Gogins, 07/22/2006

;           The first part of the score will specify all function
;       tables used in the piece. The second part specifies
;       the instruments and notes. The latter is divided into
;       7 sections, each playing a chord on a different
;                 instrument.
;       The chords are uncommon guitar chords that use the open
;       B and E strings often. These will be transposed by
;       octaves on some chords.

;       Each instrument will play a chord for 15 seconds. The
;                 timbre
;       of the instrument will change in that interval and join
;       with the next instrument/chord sequence. Instrument 3
;       uses a modified FM synthesis technique. This is joined
;       by an additional plucked-string instrument
;       (instruments 1 and 2).

;   The Function Tables
;   -------------------
;All functions are post-normalized (max value is 1) if p4 is
;POSITIVE.

f1 0 65537  10 1      ;sine wave
f2 0 65537  11 1      ;cosine wave
f3 0 65537 -12 20.0   ;unscaled ln(I(x)) from 0 to 20.0

;-----------------------------------------------------------

;----- This section comprises all the new FM sounds -----------

;F#7addB chord on a guitar
i3 0 15 0 7.06 2.0 0.2  ;F#
i3 . . . 8.01 . .   ;C# above
i3 . . . 8.06 . .   ;F# octave above 1st one
i3 . . . 8.10 . .   ;Bb next one up
i3 . . . 8.11 . .   ;B
i3 . . . 9.04 . .   ;E

;D6add9 chord on a guitar
i3 7.5 15 0 6.02 1.7 0.5    ;D
i3 . . . 6.09 . .   ;A above
i3 . . . 7.02 . .   ;D octave above 1st one
i3 . . . 7.06 . .   ;F# next one up
i3 . . . 6.11 . .   ;B
i3 . . . 7.04 . .   ;E

;Bmajadd11 chord on a guitar
i3 15 15 0 7.11 1.4 0.8 ;B
i3 . . . 8.06 . .   ;F# above
i3 . . . 8.11 . .   ;B octave above 1st one
i3 . . . 9.03 . .   ;D# next one up
i3 . . . 8.11 . .   ;B
i3 . . . 9.04 . .   ;E;

;Amajadd9 chord on a guitar
i3 22.5 15 0 6.09 1.1 1.1   ;A
i3 . . . 7.04 . .   ;E above
i3 . . . 8.09 . .   ;A octave above 1st one
i3 . . . 8.01 . .   ;C# next one up
i3 . . . 7.11 . .   ;B
i3 . . . 8.04 . .   ;E

;Bmajadd11 chord on a guitar
i3 30 15 0 6.11 0.8 1.4 ;B
i3 . . . 7.06 . .   ;F# above
i3 . . . 7.11 . .   ;B octave above 1st one
i3 . . . 8.03 . .   ;D# next one up
i3 . . . 7.11 . .   ;B
i3 . . . 8.04 . .   ;E;

;Gmaj6 chord on a guitar
i3 37.5 15 0 5.07 0.5 1.7   ;G
i3 . . . 6.02 . .   ;D above
i3 . . . 6.07 . .   ;G octave above 1st one
i3 . . . 6.11 . .   ;B on G string
i3 . . . 6.11 . .   ;B
i3 . . . 7.04 . .   ;E

;F#7addB chord on a guitar
i3 45 15 0 7.06 0.2 2.0 ;F#
i3 . . . 8.01 . .   ;C# above
i3 . . . 8.06 . .   ;F# octave above 1st one
i3 . . . 8.10 . .   ;Bb next one up
i3 . . . 8.11 . .   ;B
i3 . . . 9.04 . .   ;E

; This section adds the plucked chords to the beginning of each
; section.

;F#7addB chord on a guitar
i1 0 10 0 8.06  ;F#
i1 0.1 . . 9.01 ;C# above
i1 0.2 . . 9.06 ;F# octave above 1st one
i1 0.3 . . 9.10 ;Bb next one up
i1 0.4 . . 9.11 ;B
i1 0.5 . . 10.04    ;E

;D6add9 chord on a guitar
i2 7.5 10 0 8.02    ;D
i2 7.6 . . 8.09     ;A above
i2 7.7 . . 9.02     ;D octave above 1st one
i2 7.8 . . 9.06     ;F# next one up
i2 7.9 . . 9.11     ;B
i2 8.0 . . 10.04    ;E

;Bmajadd11 chord on a guitar
i2 15 10 0 8.11     ;B
i2 15.1 . . 9.06    ;F# above
i2 15.2 . . 9.11    ;B octave above 1st one
i2 15.3 . . 10.03   ;D# next one up
i2 15.4 . . 9.11    ;B
i2 15.5 . . 10.04   ;E;

;Amajadd9 chord on a guitar
i2 22.5 10 0 8.09   ;A
i2 22.6 . . 9.04    ;E above
i2 22.7 . . 10.09   ;A octave above 1st one
i2 22.8 . . 10.01   ;C# next one up
i2 22.9 . . 9.11    ;B
i2 23.0 . . 10.04   ;E

;Bmajadd11 chord on a guitar
i2 30 10 0 8.11     ;B
i2 30.1 . . 9.06    ;F# above
i2 30.2 . . 9.11    ;B octave above 1st one
i2 30.3 . . 10.03   ;D# next one up
i2 30.4 . . 9.11    ;B
i2 30.5 . . 10.04   ;E;

;Gmaj6 chord on a guitar
i2 37.5 10 0 8.07   ;G
i2 37.6 . . 9.02    ;D above
i2 37.7 . . 9.07    ;G octave above 1st one
i2 37.8 . . 9.11    ;B on G string
i2 37.9 . . 9.11    ;B
i2 38.0 . . 10.04   ;E

;F#7addB chord on a guitar
i1 45 10 0 9.06     ;F#
i1 45.1 . . 10.01   ;C# above
i1 45.2 . . 10.06   ;F# octave above 1st one
i1 45.3 . . 10.10   ;Bb next one up
i1 45.4 . . 10.11   ;B
i1 45.5 . . 11.04   ;E
e
</CsScore>
</CsoundSynthesizer>    
</textarea>
<textarea id='console' style="width:98vw;height:25vh;font-family:monospace;background-color:DarkSlateGrey;color:LawnGreen;">
</textarea>
</body>
</html>


